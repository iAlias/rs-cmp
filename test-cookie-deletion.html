<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RS-CMP Cookie Deletion Test</title>
  <script src="/dist/cmp-js.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #2563eb;
      color: white;
      font-size: 14px;
    }
    button:hover {
      background: #1d4ed8;
    }
    button.reject {
      background: #dc2626;
    }
    button.reject:hover {
      background: #b91c1c;
    }
    #cookie-list {
      margin-top: 15px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .cookie-item {
      padding: 5px;
      margin: 3px 0;
      background: white;
      border-left: 3px solid #2563eb;
      padding-left: 10px;
    }
    .cookie-item.analytics {
      border-color: #f59e0b;
    }
    .cookie-item.marketing {
      border-color: #dc2626;
    }
    .cookie-item.necessary {
      border-color: #10b981;
    }
    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .test-result.pass {
      background: #d1fae5;
      color: #065f46;
    }
    .test-result.fail {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <h1>RS-CMP Cookie Deletion Test</h1>
  
  <div class="test-section">
    <h2>Step 1: Set Test Cookies</h2>
    <p>This will set cookies from all categories (necessary, analytics, marketing).</p>
    <button onclick="setTestCookies()">Set Test Cookies</button>
    <button onclick="showCurrentCookies()">Show Current Cookies</button>
  </div>
  
  <div class="test-section">
    <h2>Step 2: Test Reject All</h2>
    <p>Click "Reject All" to test if analytics and marketing cookies are deleted.</p>
    <button class="reject" onclick="testRejectAll()">Reject All</button>
    <button onclick="testAcceptAll()">Accept All</button>
    <div id="test-result"></div>
  </div>
  
  <div class="test-section">
    <h2>Current Cookies</h2>
    <div id="cookie-list"></div>
  </div>
  
  <script>
    // Set test cookies for different categories
    function setTestCookies() {
      // Analytics cookies
      document.cookie = "_ga=test_ga_value; path=/";
      document.cookie = "_ga_C7XGPG5T37=test_ga_value; path=/";
      document.cookie = "_gcl_au=test_gcl_au_value; path=/";
      document.cookie = "_clck=test_clck_value; path=/";
      document.cookie = "_clsk=test_clsk_value; path=/";
      document.cookie = "CLID=test_clid_value; path=/";
      document.cookie = "ai_session=test_ai_session_value; path=/";
      document.cookie = "ai_user=test_ai_user_value; path=/";
      
      // Marketing cookies
      document.cookie = "_fbp=test_fbp_value; path=/";
      document.cookie = "IDE=test_ide_value; path=/";
      document.cookie = "NID=test_nid_value; path=/";
      document.cookie = "AEC=test_aec_value; path=/";
      document.cookie = "APISID=test_apisid_value; path=/";
      document.cookie = "SAPISID=test_sapisid_value; path=/";
      document.cookie = "HSID=test_hsid_value; path=/";
      document.cookie = "SID=test_sid_value; path=/";
      document.cookie = "SSID=test_ssid_value; path=/";
      document.cookie = "SIDCC=test_sidcc_value; path=/";
      document.cookie = "MUID=test_muid_value; path=/";
      document.cookie = "wd=test_wd_value; path=/";
      document.cookie = "ps_l=test_ps_l_value; path=/";
      document.cookie = "SEARCH_SAMESITE=test_value; path=/";
      document.cookie = "S=test_s_value; path=/";
      
      // Necessary cookies
      document.cookie = ".ASPXANONYMOUS=test_aspx_value; path=/";
      document.cookie = "ASP.NET_Sessionld=test_session_value; path=/";
      document.cookie = "cityidc_95024=test_store_value; path=/";
      
      console.log('[Test] Test cookies set!');
      
      // Rescan cookies
      if (window.RSCMP && window.RSCMP.cookieScanner) {
        window.RSCMP.cookieScanner.performInitialScan();
      }
      
      showCurrentCookies();
    }
    
    function showCurrentCookies() {
      const container = document.getElementById('cookie-list');
      
      // Get cookies directly from document.cookie
      const cookieStrings = document.cookie.split(';');
      const cookies = [];
      
      for (const cookieString of cookieStrings) {
        const trimmed = cookieString.trim();
        if (!trimmed) continue;
        
        const [name] = trimmed.split('=');
        if (!name) continue;
        
        // Categorize
        let category = 'unknown';
        if (window.RSCMP && window.RSCMP.cookieScanner) {
          category = window.RSCMP.cookieScanner.categorizeCookie(name);
        }
        
        cookies.push({ name, category });
      }
      
      // Group by category
      const grouped = {
        necessary: [],
        analytics: [],
        marketing: [],
        preferences: [],
        unknown: []
      };
      
      cookies.forEach(cookie => {
        grouped[cookie.category].push(cookie);
      });
      
      let html = '<h3>Total Cookies: ' + cookies.length + '</h3>';
      
      for (const [category, cookieList] of Object.entries(grouped)) {
        if (cookieList.length > 0) {
          html += '<h4>' + category.toUpperCase() + ' (' + cookieList.length + ')</h4>';
          cookieList.forEach(cookie => {
            html += '<div class="cookie-item ' + category + '"><strong>' + cookie.name + '</strong> - ' + cookie.category + '</div>';
          });
        }
      }
      
      container.innerHTML = html;
      
      return { total: cookies.length, ...Object.fromEntries(Object.entries(grouped).map(([k, v]) => [k, v.length])) };
    }
    
    function testRejectAll() {
      console.log('[Test] Testing Reject All...');
      
      // Get current cookie count
      const beforeStats = showCurrentCookies();
      console.log('[Test] Before Reject All:', beforeStats);
      
      // Trigger reject all
      if (window.RSCMP && window.RSCMP.consentManager) {
        window.RSCMP.consentManager.rejectAll('1.0');
        
        // Wait a bit for the operation to complete
        setTimeout(() => {
          const afterStats = showCurrentCookies();
          console.log('[Test] After Reject All:', afterStats);
          
          // Check if analytics and marketing cookies were deleted
          const resultDiv = document.getElementById('test-result');
          if (afterStats.analytics === 0 && afterStats.marketing === 0 && afterStats.necessary > 0) {
            resultDiv.className = 'test-result pass';
            resultDiv.innerHTML = '✓ PASS: Analytics and marketing cookies deleted, necessary cookies preserved!';
          } else {
            resultDiv.className = 'test-result fail';
            resultDiv.innerHTML = `✗ FAIL: Expected 0 analytics and 0 marketing cookies, but found ${afterStats.analytics} analytics and ${afterStats.marketing} marketing cookies.`;
          }
        }, 500);
      } else {
        alert('CMP not initialized!');
      }
    }
    
    function testAcceptAll() {
      console.log('[Test] Testing Accept All...');
      
      if (window.RSCMP && window.RSCMP.consentManager) {
        window.RSCMP.consentManager.acceptAll('1.0');
        
        setTimeout(() => {
          showCurrentCookies();
          const resultDiv = document.getElementById('test-result');
          resultDiv.className = 'test-result pass';
          resultDiv.innerHTML = '✓ All cookies accepted. You can now set test cookies and try "Reject All" again.';
        }, 500);
      }
    }
    
    // Auto-initialize CMP without showing banner
    if (window.RSCMP) {
      // Don't show banner on load for testing
      const originalShow = window.RSCMP.bannerUI.show.bind(window.RSCMP.bannerUI);
      window.RSCMP.bannerUI.show = function() {
        console.log('[Test] Banner show suppressed for testing');
      };
      
      window.RSCMP.init().then(() => {
        console.log('[Test] CMP initialized');
        console.log('[Test] CookieScanner:', window.RSCMP.cookieScanner);
        
        // Set test cookies after initialization
        setTimeout(() => {
          setTestCookies();
        }, 500);
      });
    }
  </script>
</body>
</html>
