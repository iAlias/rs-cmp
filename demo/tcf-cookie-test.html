<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCF 2.2 & Cookie Scanner Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #2563eb;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1e40af;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        #results {
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>TCF 2.2 & Cookie Scanner Test</h1>
    
    <div class="test-section">
        <h2>1. TCF 2.2 API Tests</h2>
        <p>Test the IAB Transparency & Consent Framework 2.2 implementation</p>
        
        <button onclick="testTCFPing()">Test __tcfapi ping</button>
        <button onclick="testGetTCData()">Test getTCData</button>
        <button onclick="testGetVendorList()">Test getVendorList</button>
        
        <h3>Results:</h3>
        <pre id="tcf-results">Click a button to test...</pre>
    </div>

    <div class="test-section">
        <h2>2. Cookie Scanner Tests</h2>
        <p>Test automatic cookie detection and categorization</p>
        
        <button onclick="addTestCookies()">Add Test Cookies</button>
        <button onclick="testCookieScanner()">Run Cookie Scanner</button>
        <button onclick="showDetectedCookies()">Show Detected Cookies</button>
        
        <h3>Results:</h3>
        <pre id="cookie-results">Click a button to test...</pre>
    </div>

    <div class="test-section">
        <h2>3. Integration Tests</h2>
        <p>Test the integration of TCF and Cookie Scanner with consent flow</p>
        
        <button onclick="acceptAllConsent()">Accept All Cookies</button>
        <button onclick="rejectAllConsent()">Reject All Cookies</button>
        <button onclick="checkTCFString()">Check TCF String</button>
        
        <h3>Results:</h3>
        <pre id="integration-results">Click a button to test...</pre>
    </div>

    <div class="test-section">
        <h2>4. Window API Check</h2>
        <p>Verify that window.__tcfapi is available</p>
        <pre id="api-check">Checking...</pre>
    </div>

    <!-- Load the CMP SDK (built version) -->
    <script src="../dist/cmp.js"></script>
    
    <script>
        // Check if __tcfapi is available on load
        window.addEventListener('load', function() {
            const apiCheck = document.getElementById('api-check');
            if (typeof window.__tcfapi === 'function') {
                apiCheck.innerHTML = '<span class="success">✓ window.__tcfapi is available</span>';
            } else {
                apiCheck.innerHTML = '<span class="error">✗ window.__tcfapi is NOT available</span>';
            }
        });

        // TCF Tests
        function testTCFPing() {
            const results = document.getElementById('tcf-results');
            results.textContent = 'Testing...';
            
            window.__tcfapi('ping', 2, function(pingReturn, success) {
                if (success) {
                    results.textContent = JSON.stringify(pingReturn, null, 2);
                } else {
                    results.textContent = 'Error: ping failed';
                }
            });
        }

        function testGetTCData() {
            const results = document.getElementById('tcf-results');
            results.textContent = 'Testing...';
            
            window.__tcfapi('getTCData', 2, function(tcData, success) {
                if (success) {
                    results.textContent = JSON.stringify({
                        tcString: tcData.tcString,
                        gdprApplies: tcData.gdprApplies,
                        cmpId: tcData.cmpId,
                        purposeConsents: tcData.purpose.consents,
                        vendorConsents: Object.keys(tcData.vendor.consents).length + ' vendors'
                    }, null, 2);
                } else {
                    results.textContent = 'Error: getTCData failed';
                }
            });
        }

        function testGetVendorList() {
            const results = document.getElementById('tcf-results');
            results.textContent = 'Testing...';
            
            window.__tcfapi('getVendorList', 2, function(vendorList, success) {
                if (success) {
                    results.textContent = JSON.stringify({
                        vendorListVersion: vendorList.vendorListVersion,
                        purposeCount: vendorList.purposes.length,
                        vendorCount: vendorList.vendors.length,
                        purposes: vendorList.purposes.map(p => ({ id: p.id, name: p.name })),
                        vendors: vendorList.vendors.map(v => ({ id: v.id, name: v.name }))
                    }, null, 2);
                } else {
                    results.textContent = 'Error: getVendorList failed';
                }
            });
        }

        // Cookie Scanner Tests
        function addTestCookies() {
            const results = document.getElementById('cookie-results');
            
            // Add various test cookies
            document.cookie = '_ga=test_analytics; path=/';
            document.cookie = '_fbp=test_marketing; path=/';
            document.cookie = 'theme=dark; path=/';
            document.cookie = 'lang=en; path=/';
            document.cookie = 'session_id=test123; path=/';
            
            results.textContent = 'Added test cookies:\n- _ga (Analytics)\n- _fbp (Marketing)\n- theme (Preferences)\n- lang (Preferences)\n- session_id (Necessary)';
        }

        function testCookieScanner() {
            const results = document.getElementById('cookie-results');
            results.textContent = 'Scanning...';
            
            setTimeout(() => {
                if (window.RSCMP && typeof window.RSCMP.getDetectedCookies === 'function') {
                    const cookies = window.RSCMP.getDetectedCookies();
                    results.textContent = 'Found ' + cookies.length + ' cookies:\n\n' + 
                        JSON.stringify(cookies, null, 2);
                } else {
                    results.textContent = 'Error: RSCMP or getDetectedCookies not available';
                }
            }, 1000);
        }

        function showDetectedCookies() {
            const results = document.getElementById('cookie-results');
            
            if (window.RSCMP && typeof window.RSCMP.getDetectedCookies === 'function') {
                const cookies = window.RSCMP.getDetectedCookies();
                
                const categorized = {};
                cookies.forEach(cookie => {
                    const cat = cookie.category || 'unclassified';
                    if (!categorized[cat]) categorized[cat] = [];
                    categorized[cat].push(cookie.name);
                });
                
                let output = 'Cookies by Category:\n\n';
                for (const [category, names] of Object.entries(categorized)) {
                    output += category.toUpperCase() + ':\n';
                    names.forEach(name => {
                        output += '  - ' + name + '\n';
                    });
                    output += '\n';
                }
                
                results.textContent = output;
            } else {
                results.textContent = 'Error: RSCMP not available';
            }
        }

        // Integration Tests
        function acceptAllConsent() {
            const results = document.getElementById('integration-results');
            results.textContent = 'Accepting all cookies...';
            
            // Simulate consent acceptance
            if (window.RSCMP && window.RSCMP.consentManager) {
                const categories = {
                    necessary: true,
                    analytics: true,
                    marketing: true,
                    preferences: true
                };
                
                window.RSCMP.consentManager.setConsent(categories, '1.0');
                
                setTimeout(() => {
                    results.textContent = 'Consent accepted!\n\nCheck TCF String to see updated data.';
                }, 500);
            } else {
                results.textContent = 'Error: RSCMP not fully initialized';
            }
        }

        function rejectAllConsent() {
            const results = document.getElementById('integration-results');
            results.textContent = 'Rejecting all cookies...';
            
            if (window.RSCMP && window.RSCMP.consentManager) {
                const categories = {
                    necessary: true,
                    analytics: false,
                    marketing: false,
                    preferences: false
                };
                
                window.RSCMP.consentManager.setConsent(categories, '1.0');
                
                setTimeout(() => {
                    results.textContent = 'Consent rejected!\n\nCheck TCF String to see updated data.';
                }, 500);
            } else {
                results.textContent = 'Error: RSCMP not fully initialized';
            }
        }

        function checkTCFString() {
            const results = document.getElementById('integration-results');
            
            if (window.RSCMP && typeof window.RSCMP.getTCFData === 'function') {
                const tcfData = window.RSCMP.getTCFData();
                
                if (tcfData) {
                    results.textContent = 'TCF Data:\n\n' + JSON.stringify({
                        tcString: tcfData.tcString.substring(0, 50) + '...',
                        fullLength: tcfData.tcString.length,
                        gdprApplies: tcfData.gdprApplies,
                        cmpId: tcfData.cmpId,
                        cmpVersion: tcfData.cmpVersion,
                        purposeConsents: tcfData.purposeConsents,
                        vendorConsents: Object.keys(tcfData.vendorConsents).filter(k => tcfData.vendorConsents[k]).join(', ')
                    }, null, 2);
                } else {
                    results.textContent = 'No TCF data available yet. Try accepting or rejecting consent first.';
                }
            } else {
                results.textContent = 'Error: getTCFData not available';
            }
        }

        // Auto-run some tests after page load
        setTimeout(() => {
            console.log('=== Auto-running initial tests ===');
            testTCFPing();
            addTestCookies();
            setTimeout(() => {
                testCookieScanner();
            }, 1000);
        }, 2000);
    </script>
</body>
</html>
